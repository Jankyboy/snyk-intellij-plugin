package io.snyk.plugin.ui.toolwindow

import com.intellij.ide.BrowserUtil
import com.intellij.ui.BrowserHyperlinkListener
import com.intellij.ui.components.labels.LinkLabel
import com.intellij.uiDesigner.core.GridConstraints
import com.intellij.uiDesigner.core.GridLayoutManager
import com.intellij.uiDesigner.core.Spacer
import com.intellij.util.ui.JBHtmlEditorKit
import com.intellij.util.ui.UIUtil
import icons.SnykIcons
import io.snyk.plugin.cli.Vulnerability
import io.snyk.plugin.ui.buildBoldTitleLabel
import io.snyk.plugin.ui.buildTwoLabelsPanel
import org.commonmark.parser.Parser
import org.commonmark.renderer.html.HtmlRenderer
import java.awt.*
import javax.swing.JButton
import javax.swing.JEditorPane
import javax.swing.JLabel
import javax.swing.JPanel
import javax.swing.UIManager
import javax.swing.text.html.HTMLDocument


class VulnerabilityDescriptionPanel(private val groupedVulns: Collection<Vulnerability>) : JPanel() {

    private val vulnerability = groupedVulns.first()

    private fun baseGridConstraints(
        row: Int,
        column: Int = 0,
        rowSpan: Int = 1,
        colSpan: Int = 1,
        anchor: Int = GridConstraints.ANCHOR_WEST,
        fill: Int = GridConstraints.FILL_NONE,
        HSizePolicy: Int = GridConstraints.SIZEPOLICY_FIXED,
        VSizePolicy: Int = GridConstraints.SIZEPOLICY_FIXED,
        minimumSize: Dimension? = null,
        preferredSize: Dimension? = null,
        maximumSize: Dimension? = null,
        indent: Int = 1,
        useParentLayout: Boolean = false
    ): GridConstraints {
        return GridConstraints(
            row, column, rowSpan, colSpan, anchor, fill, HSizePolicy, VSizePolicy, minimumSize, preferredSize,
            maximumSize, indent, useParentLayout
        )
    }

    private fun panelGridConstraints(row: Int) = baseGridConstraints(
        row = row,
        anchor = GridConstraints.ANCHOR_CENTER,
        fill = GridConstraints.FILL_BOTH,
        HSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK or GridConstraints.SIZEPOLICY_CAN_GROW,
        VSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK or GridConstraints.SIZEPOLICY_CAN_GROW,
        indent = 0
    )

    init {
        this.layout = GridLayoutManager(10, 1, Insets(20, 0, 20, 20), -1, 10)

        this.add(
            Spacer(),
            panelGridConstraints(9)
        )

        this.add(
            getMainBodyPanel(),
            panelGridConstraints(1)
        )

        this.add(
            getDetailedPathsPanel(),
            panelGridConstraints(2)
        )

        this.add(
            getOverviewPanel(),
            panelGridConstraints(3)
        )

        this.add(
            getTitlePanel(),
            panelGridConstraints(0)
        )
    }

    private fun getMainBodyPanel(): JPanel {
        val panel = JPanel()
        panel.layout = GridLayoutManager(11, 1, Insets(0, 0, 0, 0), -1, -1)

        panel.add(buildTwoLabelsPanel("Vulnerable module:", vulnerability.name),
            baseGridConstraints(2)
        )

        val introducedThroughText = //vulnerability.from.joinToString()
            groupedVulns.asSequence()
                .map { it.from[1] }
                .distinct()
                .joinToString()
        panel.add(buildTwoLabelsPanel("Introduced through:", introducedThroughText),
            baseGridConstraints(3)
        )

        panel.add(buildTwoLabelsPanel("Exploit maturity:", vulnerability.exploit),
            baseGridConstraints(4)
        )

        panel.add(
            buildTwoLabelsPanel(
                "Fixed in:",
                vulnerability.fixedIn.joinToString(prefix = "${vulnerability.name}@", separator = ", @")),
            baseGridConstraints(5)
        )

        val fixPanel = JPanel()
        fixPanel.isVisible = false
        fixPanel.layout = GridLayoutManager(1, 2, Insets(0, 0, 0, 0), -1, -1)

        panel.add(fixPanel,
            baseGridConstraints(
                6,
                anchor = GridConstraints.ANCHOR_CENTER,
                fill = GridConstraints.FILL_BOTH,
                HSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK or GridConstraints.SIZEPOLICY_CAN_GROW,
                VSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK or GridConstraints.SIZEPOLICY_CAN_GROW
            )
        )

        val fixIssueButton = JButton()
        fixIssueButton.text = "Fix this vulnerability"

        fixPanel.add(fixIssueButton,
            baseGridConstraints(
                row = 0,
                anchor = GridConstraints.ANCHOR_CENTER,
                fill = GridConstraints.FILL_HORIZONTAL,
                HSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK or GridConstraints.SIZEPOLICY_CAN_GROW,
                indent = 0
            )
        )

        fixPanel.add(Spacer(),
            baseGridConstraints(
                row = 0,
                column = 1,
                anchor = GridConstraints.ANCHOR_CENTER,
                fill = GridConstraints.FILL_HORIZONTAL,
                HSizePolicy = GridConstraints.SIZEPOLICY_WANT_GROW,
                VSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK,
                indent = 0
            )
        )

        return panel
    }

    private fun getDetailedPathsPanel(): JPanel {
        val detailsPanel = JPanel()
        detailsPanel.layout = GridLayoutManager(2, 2, Insets(0, 0, 0, 0), -1, -1)

        detailsPanel.add(
            buildBoldTitleLabel("Detailed paths"),
            baseGridConstraints(
                row = 0
            )
        )

        detailsPanel.add(
            getInnerDetailedPathsPanel(3),
            baseGridConstraints(
                row = 1,
                indent = 0
            )
        )

        return detailsPanel
    }

    private fun getInnerDetailedPathsPanel(itemsToShow: Int? = null): JPanel {
        val detailsPanel = JPanel()
        detailsPanel.layout = GridLayoutManager(groupedVulns.size + 2, 2, Insets(0, 0, 0, 0), -1, -1)

        groupedVulns
            .take(itemsToShow ?: groupedVulns.size)
            .forEachIndexed { index, vuln ->
                val detailPanel = JPanel()
                detailPanel.layout = GridLayoutManager(2, 2, Insets(0, 0, 0, 0), -1, 0)
                detailPanel.add(buildTwoLabelsPanel("Introduced through:", vuln.from.joinToString(separator = " > ")),
                    baseGridConstraints(
                        row = 0,
                        HSizePolicy = GridConstraints.SIZEPOLICY_CAN_GROW or GridConstraints.SIZEPOLICY_CAN_SHRINK,
                        VSizePolicy = GridConstraints.SIZEPOLICY_CAN_GROW or GridConstraints.SIZEPOLICY_CAN_SHRINK,
                        indent = 0
                    )
                )

                val remediationText = if (vuln.upgradePath.isNotEmpty()) {
                    "Upgrade to " + vuln.upgradePath[1]
                } else ""
                detailPanel.add(
                    buildTwoLabelsPanel("Remediation:", remediationText),
                    baseGridConstraints(
                        row = 1,
                        indent = 0
                    )
                )

                detailsPanel.add(
                    detailPanel,
                    baseGridConstraints(
                        row = index + 1
                    )
                )
            }

        if (itemsToShow != null && itemsToShow < groupedVulns.size) {
            val showMoreLabel = LinkLabel.create("...and ${groupedVulns.size - itemsToShow} more") {
                detailsPanel.removeAll()
                detailsPanel.add(
                    getInnerDetailedPathsPanel(),
                    baseGridConstraints(
                        row = 0,
                        indent = 0
                    )
                )
                this.revalidate()
                this.repaint()
            }
            detailsPanel.add(
                showMoreLabel,
                baseGridConstraints(groupedVulns.size + 1)
            )
        }

        return detailsPanel
    }

    private fun getTitlePanel(): JPanel {
        val titlePanel = JPanel()
        titlePanel.layout = GridLayoutManager(2, 1, Insets(0, 0, 0, 0), -1, 5)

        val titleLabel = JLabel().apply {
            font = io.snyk.plugin.ui.getFont(Font.BOLD, 20, font)
            text = " ${vulnerability.title}"
            icon = SnykIcons.getSeverityIcon(vulnerability.severity, SnykIcons.IconSize.SIZE24)
        }

        titlePanel.add(
            titleLabel,
            baseGridConstraints(0)
        )

        titlePanel.add(
            cwePanel(),
            baseGridConstraints(1, indent = 0)
        )

        return titlePanel
    }

    private fun cwePanel(): Component {
        val panel = JPanel()
        val cwes = vulnerability.identifiers.CWE
        val cves = vulnerability.identifiers.CVE

        val columnCount = 1 + // `Vulnerability` label
            cwes.size * 2 + // CWEs with `|`
            cves.size * 2 + // CVEs with `|`
            2 + // CVSS
            2 // Snyk description
        panel.layout = GridLayoutManager(1, columnCount, Insets(0, 0, 0, 0), 5, 0)

        panel.add(
            JLabel("Vulnerability"),
            baseGridConstraints(0)
        )

        var lastColumn =
            addItemsToPanel(panel, 0, cwes) { "https://cwe.mitre.org/data/definitions/${it.removePrefix("CWE-")}.html" }

        lastColumn =
            addItemsToPanel(panel, lastColumn, cves) { "https://cve.mitre.org/cgi-bin/cvename.cgi?name=$it" }

        lastColumn =
            addItemsToPanel(panel, lastColumn,
                arrayOf("CVSS ${vulnerability.cvssScore}")
            ) { "https://www.first.org/cvss/calculator/3.1#${vulnerability.CVSSv3}" }

        lastColumn =
            addItemsToPanel(panel, lastColumn,
                arrayOf(vulnerability.id.toUpperCase())
            ) { "https://snyk.io/vuln/${vulnerability.id}" }

        return panel
    }

    private fun addItemsToPanel(panel: JPanel, startingColumn: Int, items: Array<String>, buildUrl: (String) -> String): Int {
        var currentColumn = startingColumn
        items.forEachIndexed() { index, item ->
            if (item.isNotEmpty()) {
                val positionLabel = LinkLabel.create(item) {
                    val url = buildUrl(item)
                    BrowserUtil.open(url)
                }
                currentColumn++
                panel.add(
                    JLabel(" | ").apply {
                        this.foreground = Color(this.foreground.red, this.foreground.green, this.foreground.blue, 50)
                    },
                    baseGridConstraints(0, column = currentColumn, indent = 0)
                )

                currentColumn++
                panel.add(positionLabel, baseGridConstraints(0, column = currentColumn, indent = 0))
            }
        }
        return currentColumn
    }

    private fun getOverviewPanel(): JPanel {
        val overviewPanel = JPanel()
        overviewPanel.layout = GridLayoutManager(2, 1, Insets(0, 0, 0, 0), -1, 0)

        /*
                overviewPanel.add(buildBoldTitleLabel("Overview"),
                    baseGridConstraints(
                        row = 0,
                        indent = 0
                    )
                )
        */

        // don't remove that!
        // Some magic (side-effect?) happens when JBHtmlEditorKit() initializing
        // that make html tags like <em>, <p>, <ul> etc. be treated properly inside JEditorPane
        // PS occasionally found that when played with com.intellij.util.ui.HtmlPanel
        // PSS Good luck if you try to understand the reason of that magic (customStyleSheet?)... I gave up...
        JBHtmlEditorKit()

        val descriptionPane = JEditorPane(
            "text/html",
            "<html>" + getDescriptionAsHtml() + "</html>"
        ).apply {
            this.isEditable = false
            this.background = UIUtil.getPanelBackground()
            this.preferredSize = Dimension() // this is the key part for shrink/grow.

            // add a CSS rule to force body tags to use the default label font
            // instead of the value in javax.swing.text.html.default.csss
            val font = UIManager.getFont("Label.font")
            val bodyRule = "body { font-family: ${font.family}; font-size: ${font.size}pt; }"
            (this.document as HTMLDocument).styleSheet.addRule(bodyRule)

            // open clicked link in browser
            this.addHyperlinkListener {
                BrowserHyperlinkListener.INSTANCE.hyperlinkUpdate(it)
            }
        }

        overviewPanel.add(descriptionPane,
            baseGridConstraints(
                row = 1,
                anchor = GridConstraints.ANCHOR_CENTER,
                fill = GridConstraints.FILL_BOTH,
                HSizePolicy = GridConstraints.SIZEPOLICY_CAN_GROW or GridConstraints.SIZEPOLICY_CAN_SHRINK,
                VSizePolicy = GridConstraints.SIZEPOLICY_CAN_GROW or GridConstraints.SIZEPOLICY_CAN_SHRINK
            )
        )
        return overviewPanel
    }

    private fun getDescriptionAsHtml(): String {
        val overviewMarkdownStr = vulnerability.description//getOverview()

        val parser = Parser.builder().build()
        val document = parser.parse(overviewMarkdownStr)

        val renderer = HtmlRenderer.builder().escapeHtml(true).build()

        return renderer.render(document)
    }
}
